<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="community">

	<select id="selectAllCommunity" resultType="kr.or.ddasum.community.model.vo.Community">
		SELECT
		    C_NO AS cNO,
		    COMMUNITY.USERNO AS userNo,
		    NICK AS nick,
		    AREA_NAME AS area,
		    SIGU_NAME AS sigu,
		    C_TITLE AS cTitle,
		    C_CONTENT AS cContent,
		    C_REGDATE AS cRegDate,
		    C_COUNT AS cCount,
		    C_DEL_YN AS cDelYN
		FROM
		    COMMUNITY 
		        LEFT JOIN MEMBER ON (COMMUNITY.USERNO = MEMBER.USERNO)
		        LEFT JOIN AREA_GROUP ON (COMMUNITY.AREA = AREA_GROUP.AREA)
		        LEFT JOIN SIGU_GROUP ON (COMMUNITY.SIGU = SIGU_GROUP.SIGU)
		WHERE
			C_DEL_YN = 'N'        
		ORDER BY
			C_NO DESC	
	</select>
	
	<select id="selectCommunityAllCount" resultType="int">
		SELECT
			COUNT(*) AS AllCount
		FROM
			COMMUNITY
		WHERE
			C_DEL_YN = 'N'	
	</select>

	<select id="searchCommunity" parameterType="hashmap" resultType="kr.or.ddasum.community.model.vo.Community">
		SELECT
		    C_NO AS cNO,
		    COMMUNITY.USERNO AS userNo,
		    NICK AS nick,
		    AREA_NAME AS area,
		    SIGU_NAME AS sigu,
		    C_TITLE AS cTitle,
		    C_CONTENT AS cContent,
		    C_REGDATE AS cRegDate,
		    C_COUNT AS cCount,
		    C_DEL_YN AS cDelYN
		FROM
		    COMMUNITY 
		        LEFT JOIN MEMBER ON (COMMUNITY.USERNO = MEMBER.USERNO)
		        LEFT JOIN AREA_GROUP ON (COMMUNITY.AREA = AREA_GROUP.AREA)
		        LEFT JOIN SIGU_GROUP ON (COMMUNITY.SIGU = SIGU_GROUP.SIGU)		        
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			<if test="type.equals('title') or type.equals('all')">
				C_TITLE LIKE '%'||#{keyword}||'%'
			</if>
			<if test="type.equals('writer') or type.equals('all')">
				AND NICK LIKE '%'||#{writer}||'%'
			</if>
				AND C_DEL_YN = 'N'
		</trim>		
		ORDER BY
			C_NO DESC			
	</select>
	
	<select id="detailOneCommunity" parameterType="int" resultType="kr.or.ddasum.community.model.vo.Community">
		SELECT
		    C_NO AS cNO,
		    COMMUNITY.USERNO AS userNo,
		    NICK AS nick,
		    AREA_NAME AS area,
		    SIGU_NAME AS sigu,
		    C_TITLE AS cTitle,
		    C_CONTENT AS cContent,
		    C_REGDATE AS cRegDate,
		    C_COUNT AS cCount,
		    C_DEL_YN AS cDelYN
		FROM
		    COMMUNITY 
		        LEFT JOIN MEMBER ON (COMMUNITY.USERNO = MEMBER.USERNO)
		        LEFT JOIN AREA_GROUP ON (COMMUNITY.AREA = AREA_GROUP.AREA)
		        LEFT JOIN SIGU_GROUP ON (COMMUNITY.SIGU = SIGU_GROUP.SIGU)		        
		WHERE
			C_NO = #{cNO} AND C_DEL_YN = 'N'        
	</select>
	
	<select id="detailComment" parameterType="int" resultType="kr.or.ddasum.community.model.vo.CommunityComment">
		SELECT
		    C_NO AS cNo,
		    COM_NO AS comNo,
		    COM_COMMENT.USERNO AS userNo,
		    NICK AS nick,
		    P_COM_NO AS pComNo,
		    COM_DEPTH AS comDepth,
		    COM_ORDER AS comOrder,
		    CASE WHEN COM_SECRET_YN = 'Y' THEN cast('***삭제된 댓글입니다***' AS NVARCHAR2(500)) ELSE COM_CONTENT END AS comContent,
		    COM_REGDATE AS comRegDate,
		    COM_SECRET_YN AS comSecretYN,
		    COM_DEL_YN AS comDelYN
		FROM
		    COM_COMMENT
		        LEFT JOIN MEMBER ON (COM_COMMENT.USERNO = MEMBER.USERNO)	
		ORDER BY DECODE(P_COM_NO, '', COM_NO), P_COM_NO, COM_ORDER
	</select>
	
	<update id="deleteCommunity" parameterType="int">
		UPDATE COMMUNITY SET C_DEL_YN = 'Y' WHERE C_NO = #{cNo} 
	</update>
	
	<update id="deleteComment" parameterType="int">
		UPDATE COM_COMMENT SET COM_DEL_YN = 'Y' WHERE COM_NO = #{comNo} 
	</update>
	
	<update id="hitCoommunity" parameterType="int">
		UPDATE COMMUNITY SET C_COUNT = C_COUNT + 1 WHERE C_NO = #{cNo}
	</update>
	
</mapper>
